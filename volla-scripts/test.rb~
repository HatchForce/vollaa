require "rubygems"
require "mechanize"


@timestamp = Time.now.strftime("%Y%m%d%H%M%S")

def get_properties(i)
 agent = Mechanize.new
 page = agent.get("http://www.makaan.com/property/omr-flats")
 table = page.parser.xpath('//table[@class="ppsearch"]')
 @data_container = []
for x in [2,5,7,8,9,13,14,15,16,18,19,24] 
 td = table[2].children()[1]
 data = td.children()[0].children()[0].children()[6].children()[1]
 property_type = 'residential'
 property_for = 'sale'
 city = 'chennai'
 state = 'andhra pradesh'
 country = 'india'
 property_title = data.children()[3].children()[1].text() + data.children()[3].children()[3].text()
 p_p = data.children()[3].children()[5].text()
 p_pr = p_p.split('.')[1].split('/')[0].split(',')
 property_price = p_pr.join()
 b =  p_p.split(/\r\n/)[2]
 b_u_a = b.split('|')[1].split(/ /)[0].split('S')[0].split(',')
 built_up_area = b_u_a.join()
 bedrooms = b.split('|')[0].split('B')[0]
 property_age = b.split('|')[3]
 description = data.children()[3].children()[9].text().split('&')[0]
 #img = data.children()[5].children()[5].children()[1].elements[1].elements[0]
 property_image = http://imgs.indiaproperty.com/images/bsearch_listingnoimage.gif
 last_update = Date.parse(data.children()[5].children()[1].text())
 more_link = '#'
@data_container << [property_type,property_for,city,state,country,property_title,description,property_price,built_up_area,bedrooms,property_age,last_update,property_image,"makaan.com",more_link]
end
File.open("makaan_#{@timestamp}.txt", 'a+') do |f|
  @data_container.each do|data| 
   puts data
 f.puts data.join("|")
end
end
